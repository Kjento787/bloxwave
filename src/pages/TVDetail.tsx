import { useState, useEffect } from "react";
import { useParams, Link } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import {
  Play,
  Star,
  Calendar,
  ChevronLeft,
  Tv,
  X,
  AlertTriangle,
  Volume2,
  VolumeX,
  ChevronRight,
  List,
} from "lucide-react";
import { Navbar } from "@/components/Navbar";
import { Footer } from "@/components/Footer";
import { MovieCarousel } from "@/components/MovieCarousel";
import { LoadingSpinner } from "@/components/LoadingSpinner";
import { ReviewSection } from "@/components/ReviewSection";
import { TMDBReviews } from "@/components/TMDBReviews";
import { WatchlistButton } from "@/components/WatchlistButton";
import { VideoPlayerRevamped } from "@/components/VideoPlayerRevamped";
import { AgeVerificationDialog } from "@/components/AgeVerificationDialog";
import { CommentsSection } from "@/components/CommentsSection";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { ScrollArea, ScrollBar } from "@/components/ui/scroll-area";
import {
  fetchTVDetails,
  fetchSimilarTV,
  fetchTVVideos,
  getImageUrl,
  isTVAdultRated,
} from "@/lib/tmdb";
import { supabase } from "@/integrations/supabase/client";
import { cn } from "@/lib/utils";

const TVDetail = () => {
  const { id } = useParams<{ id: string }>();
  const tvId = parseInt(id || "0");
  const [isPlaying, setIsPlaying] = useState(false);
  const [showTrailer, setShowTrailer] = useState(false);
  const [selectedSeason, setSelectedSeason] = useState<number | null>(null);
  const [selectedEpisode, setSelectedEpisode] = useState(1);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [showAgeVerification, setShowAgeVerification] = useState(false);
  const [playerKey, setPlayerKey] = useState(0);
  const [previewMuted, setPreviewMuted] = useState(true);
  const [showPreview, setShowPreview] = useState(false);

  const { data: tvShow, isLoading } = useQuery({
    queryKey: ["tv", tvId],
    queryFn: () => fetchTVDetails(tvId),
    enabled: !!tvId,
  });

  const { data: similarData } = useQuery({
    queryKey: ["similarTV", tvId],
    queryFn: () => fetchSimilarTV(tvId),
    enabled: !!tvId,
  });

  const { data: videosData } = useQuery({
    queryKey: ["tvVideos", tvId],
    queryFn: () => fetchTVVideos(tvId),
    enabled: !!tvId,
  });

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setIsAuthenticated(!!session?.user);
    });
  }, []);

  useEffect(() => {
    if (tvShow?.seasons && tvShow.seasons.length > 0) {
      const validSeasons = tvShow.seasons.filter(s => s.season_number > 0);
      if (validSeasons.length > 0 && selectedSeason === null) {
        setSelectedSeason(validSeasons[0].season_number);
        setSelectedEpisode(1);
      }
    }
  }, [tvShow, selectedSeason]);

  const handleSeasonChange = (newSeason: number) => {
    if (newSeason !== selectedSeason) {
      setSelectedSeason(newSeason);
      setSelectedEpisode(1);
    }
  };

  useEffect(() => {
    window.scrollTo(0, 0);
  }, [tvId]);

  useEffect(() => {
    const timer = setTimeout(() => setShowPreview(true), 2000);
    return () => clearTimeout(timer);
  }, [tvId]);

  const isAdult = tvShow ? isTVAdultRated(tvShow) : false;

  const handlePlay = () => {
    if (isAdult) {
      setShowAgeVerification(true);
    } else {
      setIsPlaying(true);
    }
  };

  const handleAgeConfirm = () => {
    setShowAgeVerification(false);
    setIsPlaying(true);
  };

  const handleNextEpisode = () => {
    if (selectedEpisode < episodeCount) {
      setSelectedEpisode(prev => prev + 1);
      setPlayerKey(prev => prev + 1);
    } else if (tvShow?.seasons) {
      const validSeasons = tvShow.seasons.filter(s => s.season_number > 0);
      const currentSeasonIndex = validSeasons.findIndex(s => s.season_number === selectedSeason);
      if (currentSeasonIndex < validSeasons.length - 1) {
        const nextSeason = validSeasons[currentSeasonIndex + 1];
        setSelectedSeason(nextSeason.season_number);
        setSelectedEpisode(1);
        setPlayerKey(prev => prev + 1);
      }
    }
  };

  const handlePreviousEpisode = () => {
    if (selectedEpisode > 1) {
      setSelectedEpisode(prev => prev - 1);
      setPlayerKey(prev => prev + 1);
    } else if (tvShow?.seasons) {
      const validSeasons = tvShow.seasons.filter(s => s.season_number > 0);
      const currentSeasonIndex = validSeasons.findIndex(s => s.season_number === selectedSeason);
      if (currentSeasonIndex > 0) {
        const prevSeason = validSeasons[currentSeasonIndex - 1];
        setSelectedSeason(prevSeason.season_number);
        const prevSeasonEpisodes = prevSeason.episode_count || 1;
        setSelectedEpisode(prevSeasonEpisodes);
        setPlayerKey(prev => prev + 1);
      }
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-background">
        <Navbar />
        <div className="flex items-center justify-center pt-32">
          <LoadingSpinner size="lg" />
        </div>
      </div>
    );
  }

  if (!tvShow) {
    return (
      <div className="min-h-screen bg-background">
        <Navbar />
        <div className="flex flex-col items-center justify-center pt-32">
          <h1 className="text-2xl font-bold mb-4">TV Show Not Found</h1>
          <Link to="/">
            <Button>Go Home</Button>
          </Link>
        </div>
      </div>
    );
  }

  const trailer = tvShow.videos?.results.find(
    (v) => v.type === "Trailer" && v.site === "YouTube"
  ) || videosData?.results.find((v) => v.type === "Trailer" && v.site === "YouTube");
  const creator = tvShow.credits?.crew.find((c) => c.job === "Creator" || c.job === "Executive Producer");
  const cast = tvShow.credits?.cast.slice(0, 12) || [];
  const currentSeason = tvShow.seasons?.find(s => s.season_number === selectedSeason);
  const episodeCount = currentSeason?.episode_count || 10;
  const validSeasons = tvShow.seasons?.filter(s => s.season_number > 0) || [];

  return (
    <div className="min-h-screen bg-background">
      <Navbar />

      <AgeVerificationDialog
        open={showAgeVerification}
        onConfirm={handleAgeConfirm}
        onCancel={() => setShowAgeVerification(false)}
        title={tvShow.name}
      />

      {isPlaying && (
        <VideoPlayerRevamped
          key={playerKey}
          contentId={tvShow.id}
          contentType="tv"
          title={tvShow.name}
          subtitle={`Season ${selectedSeason}, Episode ${selectedEpisode}`}
          season={selectedSeason || 1}
          episode={selectedEpisode}
          totalEpisodes={episodeCount}
          totalSeasons={validSeasons.length}
          onClose={() => setIsPlaying(false)}
          onNextEpisode={handleNextEpisode}
          onPreviousEpisode={handlePreviousEpisode}
          onEpisodeSelect={(ep) => {
            setSelectedEpisode(ep);
            setPlayerKey(prev => prev + 1);
          }}
          onSeasonSelect={(s) => {
            setSelectedSeason(s);
            setSelectedEpisode(1);
            setPlayerKey(prev => prev + 1);
          }}
        />
      )}

      {showTrailer && trailer && (
        <div className="fixed inset-0 z-50 bg-background flex flex-col">
          <div className="flex items-center justify-between p-4 bg-background/80 backdrop-blur-sm border-b border-border/50">
            <h2 className="text-lg font-semibold">{tvShow.name} - Trailer</h2>
            <Button variant="ghost" size="icon" onClick={() => setShowTrailer(false)}>
              <X className="h-6 w-6" />
            </Button>
          </div>
          <div className="flex-1 w-full">
            <iframe
              src={`https://www.youtube.com/embed/${trailer.key}?autoplay=1`}
              className="w-full h-full"
              allowFullScreen
              allow="autoplay; fullscreen"
            />
          </div>
        </div>
      )}

      {/* Immersive Hero */}
      <section className="relative min-h-screen">
        <div className="absolute inset-0">
          {/* Always render backdrop image as fallback */}
          <img
            src={getImageUrl(tvShow.backdrop_path, "original")}
            alt={tvShow.name}
            className="w-full h-full object-cover"
          />
          {/* Overlay YouTube preview on top if available */}
          {showPreview && trailer && (
            <div className="absolute inset-0">
              <iframe
                src={`https://www.youtube.com/embed/${trailer.key}?autoplay=1&mute=${previewMuted ? 1 : 0}&controls=0&loop=1&playlist=${trailer.key}&modestbranding=1&showinfo=0`}
                className="w-full h-full object-cover scale-125"
                allow="autoplay"
                style={{ pointerEvents: 'none' }}
              />
            </div>
          )}
          
          <div className="absolute inset-0 bg-gradient-to-r from-background via-background/90 to-background/40" />
          <div className="absolute inset-0 bg-gradient-to-t from-background via-background/50 to-transparent" />
          <div className="absolute bottom-0 left-0 right-0 h-40 bg-gradient-to-t from-background to-transparent" />
        </div>

        <div className="relative container mx-auto px-4 md:px-8 lg:px-12 pt-32 pb-16 min-h-screen flex flex-col justify-end">
          <Link
            to="/"
            className="absolute top-24 left-4 md:left-8 lg:left-12 inline-flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors glass px-4 py-2 rounded-full"
          >
            <ChevronLeft className="h-4 w-4" />
            <span className="text-sm font-medium">Back</span>
          </Link>

          {showPreview && trailer && (
            <Button
              variant="ghost"
              size="icon"
              className="absolute top-24 right-4 md:right-8 lg:right-12 glass rounded-full h-10 w-10"
              onClick={() => setPreviewMuted(!previewMuted)}
            >
              {previewMuted ? <VolumeX className="h-5 w-5" /> : <Volume2 className="h-5 w-5" />}
            </Button>
          )}

          <div className="max-w-3xl space-y-6">
            {/* Badges */}
            <div className="flex items-center gap-3 flex-wrap">
              <Badge className="bg-primary/20 text-primary border-primary/30 px-3 py-1 gap-1">
                <Tv className="h-3.5 w-3.5" />
                TV Series
              </Badge>
              {isAdult && (
                <Badge variant="destructive" className="gap-1 text-sm px-3 py-1">
                  <AlertTriangle className="h-3.5 w-3.5" />
                  18+
                </Badge>
              )}
              <Badge className="bg-primary/20 text-primary border-primary/30 px-3 py-1">
                <Star className="h-3.5 w-3.5 mr-1 fill-current" />
                {tvShow.vote_average.toFixed(1)}
              </Badge>
              <Badge variant="outline" className="px-3 py-1">
                {tvShow.first_air_date?.split("-")[0]}
              </Badge>
            </div>

            <h1 className="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-black tracking-tight text-shadow-lg font-display">
              {tvShow.name}
            </h1>

            {tvShow.tagline && (
              <p className="text-xl md:text-2xl text-foreground/70 italic font-light">
                "{tvShow.tagline}"
              </p>
            )}

            {/* Stats */}
            <div className="flex flex-wrap gap-6 text-sm font-medium">
              <div className="flex items-center gap-2">
                <Calendar className="h-4 w-4 text-primary" />
                <span>{tvShow.number_of_seasons} Seasons</span>
              </div>
              <div className="flex items-center gap-2">
                <List className="h-4 w-4 text-primary" />
                <span>{tvShow.number_of_episodes} Episodes</span>
              </div>
              {tvShow.status && (
                <Badge variant="secondary" className="px-3">
                  {tvShow.status}
                </Badge>
              )}
            </div>

            {/* Genres */}
            <div className="flex flex-wrap gap-2">
              {tvShow.genres.map((genre) => (
                <Badge 
                  key={genre.id} 
                  variant="secondary" 
                  className="px-4 py-1.5 text-sm"
                >
                  {genre.name}
                </Badge>
              ))}
            </div>

            <p className="text-base md:text-lg text-foreground/80 leading-relaxed line-clamp-3">
              {tvShow.overview}
            </p>

            {/* Season/Episode Selector - Redesigned */}
            <div className="flex flex-wrap gap-4 items-center pt-2">
              <div className="glass rounded-xl p-1.5 flex gap-1 overflow-x-auto hide-scrollbar max-w-full">
                {validSeasons.slice(0, 8).map((season) => (
                  <button
                    key={season.id}
                    onClick={() => handleSeasonChange(season.season_number)}
                    className={cn(
                      "px-4 py-2 text-sm font-medium rounded-lg transition-colors whitespace-nowrap",
                      selectedSeason === season.season_number
                        ? "bg-primary text-primary-foreground"
                        : "hover:bg-secondary/50"
                    )}
                  >
                    S{season.season_number}
                  </button>
                ))}
                {validSeasons.length > 8 && (
                  <span className="px-4 py-2 text-sm text-muted-foreground">+{validSeasons.length - 8} more</span>
                )}
              </div>
            </div>

            {/* Episode Grid */}
            <ScrollArea className="w-full pb-4">
              <div className="flex gap-2">
                {Array.from({ length: Math.min(episodeCount, 20) }, (_, i) => i + 1).map((ep) => (
                  <button
                    key={ep}
                    onClick={() => setSelectedEpisode(ep)}
                    className={cn(
                      "flex-shrink-0 w-12 h-12 rounded-lg font-semibold transition-all",
                      selectedEpisode === ep
                        ? "bg-primary text-primary-foreground scale-110"
                        : "bg-card hover:bg-secondary/50"
                    )}
                  >
                    {ep}
                  </button>
                ))}
                {episodeCount > 20 && (
                  <span className="flex items-center px-4 text-sm text-muted-foreground">+{episodeCount - 20} more</span>
                )}
              </div>
              <ScrollBar orientation="horizontal" />
            </ScrollArea>

            {/* Action Buttons */}
            <div className="flex flex-wrap items-center gap-4 pt-4">
              <Button 
                size="lg" 
                onClick={handlePlay}
                className="h-14 px-8 text-lg font-bold rounded-lg bg-foreground text-background hover:bg-foreground/90 gap-3"
              >
                <Play className="h-6 w-6 fill-current" />
                S{selectedSeason} E{selectedEpisode}
              </Button>

              {trailer && (
                <Button 
                  size="lg" 
                  variant="outline"
                  onClick={() => setShowTrailer(true)}
                  className="h-14 px-8 text-lg font-semibold rounded-lg glass gap-3"
                >
                  <Tv className="h-5 w-5" />
                  Trailer
                </Button>
              )}

              {isAuthenticated && (
                <WatchlistButton
                  contentId={tvId}
                  contentType="tv"
                  size="lg"
                  variant="outline"
                  className="h-14 w-14 rounded-lg glass"
                />
              )}
            </div>

            {creator && (
              <div className="text-sm pt-2">
                <span className="text-muted-foreground">Created by </span>
                <span className="font-semibold">{creator.name}</span>
              </div>
            )}
          </div>
        </div>
      </section>

      {/* Cast & Reviews */}
      <section className="relative z-10 -mt-20">
        <div className="container mx-auto px-4 md:px-8 lg:px-12">
          <Tabs defaultValue="cast" className="space-y-8">
            <TabsList className="glass inline-flex h-12 p-1 rounded-xl">
              <TabsTrigger value="cast" className="px-6 rounded-lg">Cast</TabsTrigger>
              <TabsTrigger value="seasons" className="px-6 rounded-lg">Seasons</TabsTrigger>
              <TabsTrigger value="reviews" className="px-6 rounded-lg">Reviews</TabsTrigger>
            </TabsList>

            <TabsContent value="cast" className="space-y-8">
              <h2 className="text-2xl font-bold">Top Cast</h2>
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                {cast.map((person) => (
                  <div 
                    key={person.id} 
                    className="group p-4 rounded-xl bg-card hover:bg-secondary/50 transition-colors text-center"
                  >
                    <div className="w-20 h-20 mx-auto rounded-full overflow-hidden bg-muted mb-3 ring-2 ring-border group-hover:ring-primary transition-colors">
                      {person.profile_path ? (
                        <img
                          src={getImageUrl(person.profile_path, "w200")}
                          alt={person.name}
                          className="w-full h-full object-cover"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-muted-foreground text-xs">
                          No Photo
                        </div>
                      )}
                    </div>
                    <p className="font-semibold text-sm line-clamp-1">{person.name}</p>
                    <p className="text-xs text-muted-foreground line-clamp-1 mt-1">
                      {person.character}
                    </p>
                  </div>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="seasons" className="space-y-6">
              <h2 className="text-2xl font-bold">All Seasons</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {validSeasons.map((season) => (
                  <button
                    key={season.id}
                    onClick={() => handleSeasonChange(season.season_number)}
                    className={cn(
                      "flex items-start gap-4 p-4 rounded-xl text-left transition-all",
                      selectedSeason === season.season_number
                        ? "bg-primary/10 border-2 border-primary"
                        : "bg-card hover:bg-secondary/50 border-2 border-transparent"
                    )}
                  >
                    <div className="w-20 h-28 rounded-lg overflow-hidden bg-muted flex-shrink-0">
                      {season.poster_path ? (
                        <img
                          src={getImageUrl(season.poster_path, "w200")}
                          alt={season.name}
                          className="w-full h-full object-cover"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-xs text-muted-foreground">
                          S{season.season_number}
                        </div>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <h3 className="font-semibold line-clamp-1">{season.name}</h3>
                      <p className="text-sm text-muted-foreground mt-1">
                        {season.episode_count} Episodes
                      </p>
                      {season.air_date && (
                        <p className="text-xs text-muted-foreground mt-1">
                          {season.air_date.split("-")[0]}
                        </p>
                      )}
                    </div>
                    <ChevronRight className={cn(
                      "h-5 w-5 flex-shrink-0 transition-colors",
                      selectedSeason === season.season_number ? "text-primary" : "text-muted-foreground"
                    )} />
                  </button>
                ))}
              </div>
            </TabsContent>

            <TabsContent value="reviews" className="space-y-8">
              <TMDBReviews contentId={tvId} contentType="tv" />
              <div className="border-t border-border/30 pt-8">
                <ReviewSection
                  contentId={tvId}
                  contentType="tv"
                  isAuthenticated={isAuthenticated}
                />
              </div>
            </TabsContent>
          </Tabs>
        </div>
      </section>

      {/* Comments */}
      <section className="container mx-auto px-4 md:px-8 lg:px-12 py-12">
        <CommentsSection contentId={tvId} contentType="tv" />
      </section>

      {/* Similar Shows */}
      {similarData?.results && similarData.results.length > 0 && (
        <section className="py-12">
          <MovieCarousel title="More Like This" movies={similarData.results} />
        </section>
      )}

      <Footer />
    </div>
  );
};

export default TVDetail;
